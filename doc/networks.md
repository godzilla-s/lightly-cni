# 网络基础概念汇总

## netns 

Linux的netns（Network Namespace）是Linux内核提供的一项强大的网络隔离功能，它能够创建多个独立的网络空间，每个空间都拥有自己独立的网络协议栈，包括网络接口（网卡）、路由表、iptables规则等。这种隔离机制使得不同的应用程序或服务可以在互不干扰的网络环境中运行，提高了系统的安全性和灵活性。以下是对netns的详细总结和示例说明

### 基本概念

netns是Linux内核提供的一种网络命名空间机制，用于实现网络资源的隔离。

**特点：**

+ 隔离性：不同的netns之间完全隔离，彼此无法直接访问对方的网络资源。
+ 独立性：每个netns都拥有自己独立的网络协议栈，包括网络接口、路由表、iptables规则等。
+ 灵活性：可以根据需要创建、删除和修改netns，以适应不同的应用场景。

### 应用场景

1. 容器网络： 用于隔离容器之间的网络资源，实现容器间的通信和隔离。
2. 虚拟网络： 用于隔离虚拟机之间的网络资源，实现虚拟机间的通信和隔离。
3. 云网络： 用于隔离云中不同租户或实例之间的网络资源，实现云中资源的通信和隔离。
4. SDN网络： 用于实现网络自动化和可编程，提高网络的可管理性和灵活性。

## 二层网络

二层网络（Layer 2 Network）是计算机网络中基于OSI模型的​​数据链路层​​（第二层）实现通信的技术，主要解决​​同一局域网（LAN）内设备间的直接通信问题​​。其核心是通过MAC地址（物理地址）寻址，无需依赖IP地址（三层网络的核心）。

### 核心概念

**核心协议：**

+ 以太网（Ethernet）： 最常见的二层协议，定义了帧格式和MAC寻址规则
+ MAC地址： 设备的唯一物理表示（比如： 02:42:c0:5e:dc:b3），用于直接寻址
+ 交换机（Switch）： 二层网络的核心设备，基于MAC地址进行数据转发的设备，实现局域网内的高速通信

**核心能力：**

+ MAC地址学习： 设备通过MAC地址表（源MAC地址学习）进行帧转发，交换机记录每个端口对应的MAC地址，实现同一个广播域内的直接通信
+ 数据帧转发
+ VLAN划分 

### 通信流程

这里以两台主机（主机A、主机B）为例：

当主机A -> 主机B 发送数据时：

1. 数据封装

+ 应用层数据： 传输层（TCP/UDP） -> 网络层（IP头）-> 数据链路层（添加MAC头）
+ 帧结构：  
```
| 目标MAC地址 | 源MAC地址 | 类型（如IPv4） | 数据（含IP包） | CRC校验 |
```

2. MAC地址学习

+ 初始状态： 交换机MAC地址表为空（可以同过`arp -a`查看）
+ 首次通信：
    + 主机A 发送帧时，交换机会记录源MAC地址（主机A）和对应的端口号到MAC表
    + 若目标MAC（主机B）不在表中，交换机会泛洪（flood）将帧发送到所有端口（除来源端口）

3. 目标响应与表现更新
+ 主机B收到帧后，会回复主机A，交换机此时学习到主机B的MAC地址和对应端口，并更新MAC表
+ 交换机直接根据MAC表单单播转发，无需泛洪

4. 广播与特殊帧处理​

+ 广播帧​​（如ARP请求）：目标MAC为 FF:FF:FF:FF:FF:FF，交换机会泛洪到所有端口
+ VLAN隔离​​：若配置了VLAN，交换机仅在同一VLAN内转发帧，实现逻辑分割。

### 应用场景

1. 局域网（LAN）通信： 同一子网内的PC、服务器、打印机等设备直接通信
2. 虚拟局域网（VLAN）：通过VLAN标签（比如IEEE 802.1Q）隔离广播域，提升安全性
3. 二层隧道协议： 如L2TP、VxLAN等，用于扩展二层网络跨越三层基础设施
4. SDN与Overlay网络： 如Open vSwitch（OVS）实现虚拟化环境中的二层连同

## 三层网络

三层网络（Layer 3 Network）是OSI模型中​​网络层​​（第三层）的实现，核心功能是通过​​逻辑寻址（如IP地址）​​实现跨子网、跨网络的通信。与二层网络（依赖MAC地址）不同，三层网络通过路由器和IP协议实现端到端的连通性，适用于广域网（WAN）和复杂拓扑场景。

### 核心概念

**核心协议与技术：**

+ ​​IP协议（IPv4/IPv6）​​：定义逻辑地址（如 192.168.1.1）和分组格式。
+ ​​路由器（Router）​​：基于路由表转发IP包，连接不同子网或网络。
+ ​​路由协议​​：如OSPF、BGP，用于动态学习路径信息。
+ ICMP​​：用于网络诊断（如 ping）。

**核心能力：**

+ IP路由
+ 策略控制
+ 跨VLAN/子网互联

### 通信流程

这里以两台主机（主机A、主机B）为例：

主机A IP： 192.168.1.100  
主机B IP： 172.10.0.10  

1. 数据封装与路由决策

+ 主机A的检测：
    + 判断目标IP（172.10.0.1）是否在同一子网（可以通过掩码255.255.255.0验证） 
    + 如果发现不同子网，将数据包发送至默认网关（如路由器接口192.168.1.1,可以通过`ip route show default`查看）
+ ARP解析网关MAC：
    + 主机A通过ARP协议获取网关的MAC地址，封装帧：
    ```
    | 目标MAC（网关） | 源MAC（主机A） | 类型（IPv4） | IP包（目标IP:172.10.0.10） |
    ```

2. 路由器的处理

+ 解封装与路由查找：
    + 路由器收到帧后，剥离二层头部，检查目标IP（172.10.0.10）。
    + 查询路由表，确定下一跳（如通过接口 172.10.0.1 转发）。
+ 重新封装与转发：
    + 路由器根据下一跳的链路类型（如以太网、PPP）重新封装数据包
        + 若下一跳是以太网，通过ARP获取目标IP（172.10.0.10） 的MAC地址。
        + 封装新帧：
        ```
        | 目标MAC（主机B） | 源MAC（路由器） | 类型（IPv4） | IP包（目标IP:10.0.0.2） |
        ```

3. 主机B接受处理

+ 主机B收到帧后，校验IP地址匹配，解封装并将数据传递给上层协议（如TCP/UDP）。

### 关键技术

1. 路由表

2. 路由协议分类
    + IGP： 内部网关协议，用于同一自治系统内，如OSPF、RIP
    + EGP： 外部网关协议，用于不同自治系统，如BGP

3. NAT（网络地址转换）
    + 解决IPv4短缺的问题，将私有IP映射为公网IP

4. VPN与隧道技术：
    + 通过IPSec/GRE等协议在公共网络上建立私有通道。


## Underlay/Overlay

​​Overlay（覆盖网络）​​和​​Underlay（底层网络）​​是两个分层架构中的核心概念，用于描述虚拟化网络与物理网络之间的关系。它们共同构成了现代云、数据中心和SDN（软件定义网络）的基础架构

### Underlay

Underlay是​​物理网络基础设施​​，由真实的硬件设备（路由器、交换机、光纤等）构成，负责提供基础的连通性和数据传输能力。

+ 核心目标： 高效、可靠地转发数据包（二层或三层）。  
+ 技术示例​​：以太网、IP路由、BGP、OSPF、VLAN等。

## TUN/TAP


**封装**

数据按照指定的格式组成数据包

**隧道**

## veth (pair)

`veth pair`（Virtual Ethernet Pair）是一种 Linux 内核技术，可用于将两个虚拟网络接口连接在一起，从而可以在两个不同的命名空间之间进行通信。它常常被用于容器的实现，比如 Docker 中的容器网络，以提供网络隔离和互联。

`eth pair` 包括两个虚拟网络接口，这两个网络接口是成对出现的，一个在一个命名空间中，另一个在另一个命名空间中。其中一个接口的主机和路由信息将用于在这个命名空间和其它网络之间进行通信，而另一个接口则被限制在本地网络命名空间中。